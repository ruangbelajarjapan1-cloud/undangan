<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#1a0bff" />
  <title>RBM Japan • Graduation</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
   :root{
  --blue:#1A56FF;
  --orange:#FF8A00;
  --gold:#F6C453;
  --white:#FFFFFF;

  --textInv:#FFFFFF;
  --muted: rgba(255,255,255,.86);

  --card: rgba(255,255,255,.18);
  --card2: rgba(255,255,255,.22);
  --line: rgba(255,255,255,.28);

  --shadow: 0 22px 70px rgba(0,0,0,.30);
  --r: 22px;
  --tap: 46px;
}

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
   body{
  margin:0;
  font-family:"Noto Sans","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color: var(--textInv);
  overflow-x:hidden;

  background:
    radial-gradient(900px 600px at 20% 10%, rgba(246,196,83,.42), transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(255,138,0,.28), transparent 60%),
    radial-gradient(1100px 700px at 50% 100%, rgba(26,86,255,.30), transparent 60%),
    linear-gradient(120deg, rgba(26,86,255,.75), rgba(255,138,0,.45), rgba(246,196,83,.35));
  background-size: 140% 140%;
  animation: bgShift 12s ease-in-out infinite alternate;
}

    @keyframes bgShift{
      0%{ background-position: 0% 30%; }
      100%{ background-position: 100% 70%; }
    }

    a{ color:inherit; }
    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 16px 14px calc(92px + env(safe-area-inset-bottom));
    }

    /* Floating bubbles (lightweight) */
    .bubbles{
      position: fixed;
      inset: 0;
      pointer-events:none;
      overflow:hidden;
      z-index: 0;
    }
    .bubble{
      position:absolute;
      width: 22vmin;
      height: 22vmin;
      border-radius: 999px;
      filter: blur(0.2px);
      opacity:.35;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,.04));
      animation: floatUp 12s linear infinite;
      border: 1px solid rgba(255,255,255,.20);
    }
    @keyframes floatUp{
      0%{ transform: translate3d(0, 110vh, 0) scale(.8); }
      100%{ transform: translate3d(10vw, -30vh, 0) scale(1.15); }
    }

    /* Top minimal bar */
    .topbar{
      position: sticky; top: 0; z-index: 20;
      backdrop-filter: blur(12px);
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid rgba(255,255,255,.16);
    }
    .topbar-inner{
      max-width: 980px; margin:0 auto;
      padding: 10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 240px;
    }
    .logo{
      width: 44px; height: 44px;
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 14px 44px rgba(0,0,0,.25);
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brand h1{ margin:0; font-size:14px; font-weight:900; line-height:1.1; }
    .brand p{ margin:2px 0 0; font-size:12px; color: rgba(255,255,255,.80); }

    .right{
      display:flex; align-items:center; gap:8px;
    }
    .chip{
      height: 34px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      display:inline-flex; align-items:center; justify-content:center;
      font-size: 12px;
      cursor: pointer;
      user-select:none;
      transition: transform .12s ease, background .2s ease;
    }
    .chip:active{ transform: scale(.98); }
    .chip.active{
      background: rgba(255,255,255,.24);
      border-color: rgba(255,255,255,.35);
    }
    .iconBtn{
      width: 38px; height: 38px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      display:grid; place-items:center;
      cursor:pointer; user-select:none;
      transition: transform .12s ease, background .2s ease;
    }
    .iconBtn:active{ transform: scale(.98); }
    .iconBtn:hover{ background: rgba(255,255,255,.16); }

    /* Cover full-screen like LinkUndangan */
    .coverWrap{
      position: fixed;
      inset: 0;
      z-index: 50;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(12px);
      transition: opacity .55s ease, transform .55s ease;
    }
    body.opened .coverWrap{
      opacity: 0;
      transform: translateY(-10px);
      pointer-events:none;
    }
    .coverCard{
      width: min(980px, 100%);
      border-radius: 28px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.10);
      position:relative;
      transform: translateY(8px);
      animation: popIn .7s ease both;
    }
    @keyframes popIn{
      from{ opacity:0; transform: translateY(18px) scale(.98); }
      to{ opacity:1; transform: translateY(0) scale(1); }
    }
    .coverMedia{
      height: 360px;
      position:relative;
      background:#111;
    }
    .slide{
      position:absolute; inset:0;
      background-size: cover;
      background-position:center;
      transform: scale(1.08);
      opacity:0;
      transition: opacity 1.1s ease;
      animation: kenburns 16s ease-in-out infinite;
      filter: saturate(1.15) contrast(1.05);
    }
    .slide.active{ opacity:1; }
    @keyframes kenburns{
      0%{ transform: scale(1.08) translate3d(0,0,0); }
      50%{ transform: scale(1.16) translate3d(-1.6%, -1.1%, 0); }
      100%{ transform: scale(1.08) translate3d(0,0,0); }
    }
    .coverMedia::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.02) 0%, rgba(0,0,0,.55) 55%, rgba(0,0,0,.78) 100%);
    }
    .coverBody{
      position:relative;
      padding: 18px 16px 16px;
    }
    .badgeRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge{
  border: 1px solid rgba(246,196,83,.45);
  background: rgba(255,255,255,.14);
}

    .toLine{ margin-top: 10px; font-size: 12px; color: rgba(255,255,255,.85); }
    .coverTitle{
      margin: 6px 0 8px;
      font-size: clamp(22px, 4.5vw, 40px);
      line-height: 1.12;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .coverDesc{
      margin: 0;
      color: rgba(255,255,255,.88);
      font-size: 14px;
      line-height: 1.7;
      max-width: 72ch;
    }
    .btnRow{
      margin-top: 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    /* Buttons + ripple */
    .btn{
      min-height: var(--tap);
      padding: 0 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      color: var(--textInv);
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      position:relative;
      overflow:hidden;
      transition: transform .12s ease, background .2s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.16); }
    .btn:active{ transform: scale(.99); }

   .btn.primary{
  background: linear-gradient(90deg,
    rgba(26,86,255,.78),
    rgba(255,138,0,.62),
    rgba(246,196,83,.55)
  );
  border-color: rgba(255,255,255,.34);
}

    .btn.ok{
      background: rgba(52,211,153,.20);
      border-color: rgba(52,211,153,.38);
    }
    .btn.danger{
      background: rgba(251,113,133,.18);
      border-color: rgba(251,113,133,.38);
    }
    .ripple{
      position:absolute;
      border-radius: 999px;
      transform: scale(0);
      animation: ripple .55s ease-out;
      background: rgba(255,255,255,.55);
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    @keyframes ripple{
      to{ transform: scale(6); opacity:0; }
    }

    /* Content cards */
    .section{ margin-top: 14px; position:relative; z-index: 5; }
    .card{
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      box-shadow: 0 16px 50px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .cardBody{ padding: 16px; }
    .card h2{ margin:0 0 10px; font-size: 15px; font-weight: 950; letter-spacing:.2px; }
    .mutedText{ color: rgba(255,255,255,.82); font-size: 12px; line-height: 1.6; }
    .hr{ height:1px; background: rgba(255,255,255,.18); margin: 12px 0; }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 12px;
      font-size: 13px;
      align-items:start;
    }
    @media (max-width: 520px){
      .kv{ grid-template-columns: 1fr; }
    }

    /* Countdown */
    .countdown{
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .cdBox{
      text-align:center;
      padding: 10px 8px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
    }
    .cdNum{ font-size: 20px; font-weight: 950; }
    .cdLbl{ font-size: 11px; color: rgba(255,255,255,.82); margin-top:4px; }

    /* Hadith */
    .arabic{
      font-size: 18px;
      line-height: 1.9;
      direction: rtl;
      text-align:right;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      margin: 8px 0 10px;
    }
    .quote{ font-size:13px; line-height:1.7; color: rgba(255,255,255,.92); }
    .source{ font-size:12px; color: rgba(255,255,255,.78); margin-top:10px; }

    /* Classes */
    .classGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 900px){ .classGrid{ grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 520px){ .classGrid{ grid-template-columns: 1fr; } }
    .classCard{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
    }
    .classCard b{ display:block; font-weight: 950; }
    .classCard .small{ font-size:12px; color: rgba(255,255,255,.82); margin-top:6px; line-height:1.6; }

    /* Gallery */
    .gallery{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 900px){ .gallery{ grid-template-columns: repeat(3,1fr); } }
    @media (max-width: 620px){ .gallery{ grid-template-columns: repeat(2,1fr); } }
    .gItem{
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      aspect-ratio: 1 / 1;
      cursor:pointer;
      position:relative;
    }
    .gItem img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      transform: scale(1.03);
      transition: transform .35s ease;
    }
    .gItem:active img{ transform: scale(1.08); }
    .lightbox{
      position:fixed; inset:0; z-index: 70;
      background: rgba(0,0,0,.78);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
    }
    .lightbox.show{ display:flex; }
    .lightbox img{
      max-width: min(980px, 94vw);
      max-height: 84vh;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: var(--shadow);
      background:#0b1220;
    }

    /* Forms */
    form{ display:grid; gap:10px; }
    label{ font-size:12px; color: rgba(255,255,255,.90); }
    input, select, textarea{
      width:100%;
      min-height: var(--tap);
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.18);
      color: var(--textInv);
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .row2{ grid-template-columns: 1fr; } }

    .radioRow{ display:flex; flex-wrap:wrap; gap:10px; }
    .radio{
      min-height: var(--tap);
      display:flex; gap:8px; align-items:center;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
    }
    .radio input{ width:auto; }

    .gbList{ display:grid; gap:10px; }
    .gbItem{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
    }
    .gbItem .meta{ font-size:12px; color: rgba(255,255,255,.78); margin-top:6px; }

    /* Reveal animation per section */
    .reveal{
      opacity: 0;
      transform: translateY(14px) scale(.995);
      transition: opacity .65s ease, transform .65s cubic-bezier(.2,.9,.2,1);
    }
    .reveal.show{
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    /* Bottom nav (mobile friendly) */
    .bottomNav{
      position: fixed;
      left: 50%;
      bottom: calc(10px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      z-index: 25;
      width: min(520px, calc(100vw - 18px));
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.20);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 60px rgba(0,0,0,.28);
      display:flex;
      justify-content:space-between;
      padding: 8px;
      gap: 6px;
    }
    .navItem{
      flex:1;
      min-height: 44px;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 4px;
      font-size: 10px;
      color: rgba(255,255,255,.88);
      text-decoration:none;
      border: 1px solid transparent;
    }
    .navItem.active{
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.22);
    }
    .navItem svg{ width: 18px; height: 18px; opacity:.95; }

    /* Toast */
    .toast{
      position: fixed;
      right: 14px;
      bottom: calc(90px + env(safe-area-inset-bottom));
      z-index: 90;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.20);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      max-width: 420px;
      display:none;
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.95);
    }
    .toast.show{ display:block; }

    /* Confetti canvas */
    #confetti{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 65;
      display:none;
    }
    body.opened #confetti{ display:block; }

    /* Accessibility: reduce motion */
    @media (prefers-reduced-motion: reduce){
      body{ animation:none; }
      .slide{ animation:none; }
      .reveal{ transition:none; }
      .bubble{ animation:none; }
    }
  </style>
</head>

<body>
  <!-- Decorative bubbles -->
  <div class="bubbles" aria-hidden="true">
    <div class="bubble" style="left:5%; animation-delay:0s; width:18vmin; height:18vmin;"></div>
    <div class="bubble" style="left:30%; animation-delay:2s; width:22vmin; height:22vmin;"></div>
    <div class="bubble" style="left:65%; animation-delay:4s; width:16vmin; height:16vmin;"></div>
    <div class="bubble" style="left:82%; animation-delay:1s; width:24vmin; height:24vmin;"></div>
  </div>

  <canvas id="confetti"></canvas>

  <!-- Cover -->
  <div class="coverWrap" id="coverWrap">
    <div class="coverCard" role="dialog" aria-modal="true" aria-label="Undangan">
      <div class="coverMedia">
        <div class="slide active" id="slideA"></div>
        <div class="slide" id="slideB"></div>
      </div>
      <div class="coverBody">
        <div class="badgeRow">
          <div class="badge" data-i18n="badge_event">Acara Kelulusan</div>
          <div class="badge" id="badgeDate">24 Januari 2026</div>
          <div class="badge">十日市場地区センター</div>
        </div>

        <div class="toLine" id="toLine" data-i18n="to_default">Kepada Yth: Tamu Undangan</div>
        <div class="coverTitle" data-i18n="cover_title">Undangan Kelulusan Siswa RBM Japan</div>
        <p class="coverDesc" data-i18n="cover_desc">
          Mari rayakan pencapaian para siswa. Klik tombol di bawah untuk membuka undangan dan mengisi RSVP.
        </p>

        <div class="btnRow">
          <button class="btn primary" id="btnOpen" type="button" data-i18n="btn_open">Buka Undangan</button>
          <button class="btn" id="btnShare" type="button" data-i18n="btn_share">Bagikan</button>
          <a class="btn" id="btnMap" target="_blank" rel="noopener" data-i18n="btn_map">Buka Peta</a>
          <button class="btn" id="btnCalendar" type="button" data-i18n="btn_calendar">Tambah ke Kalender</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">
          <!-- TEMPAT LOGO: taruh di assets/logo.png -->
          <img src="./assets/logo.png" alt="RBM Japan Logo" />
        </div>
        <div>
          <h1 data-i18n="top_title">RBM Japan • Kelulusan</h1>
          <p data-i18n="top_sub">Undangan Web + RSVP</p>
        </div>
      </div>

      <div class="right">
        <div class="chip active" data-lang="id">ID</div>
        <div class="chip" data-lang="en">EN</div>
        <div class="chip" data-lang="ja">日本語</div>

        <div class="iconBtn" id="btnMusic" title="Music">♪</div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="container">
    <section class="section card reveal" id="detail">
      <div class="cardBody">
        <h2 data-i18n="sec_detail">Detail Acara</h2>

        <div class="kv">
          <div class="mutedText" data-i18n="k_when">Waktu</div>
          <div id="whenText"></div>

          <div class="mutedText" data-i18n="k_where">Tempat</div>
          <div>
            <div><b>十日市場地区センター</b></div>
            <div class="mutedText" id="addrText"></div>
          </div>

          <div class="mutedText" data-i18n="k_access">Akses</div>
          <div data-i18n="access_text">± 5–6 menit jalan kaki dari JR 横浜線 十日市場駅.</div>
        </div>

        <div class="hr"></div>

        <h2 data-i18n="sec_countdown">Hitung Mundur</h2>
        <div class="countdown" aria-live="polite">
          <div class="cdBox"><div class="cdNum" id="cdDays">—</div><div class="cdLbl" data-i18n="cd_days">Hari</div></div>
          <div class="cdBox"><div class="cdNum" id="cdHours">—</div><div class="cdLbl" data-i18n="cd_hours">Jam</div></div>
          <div class="cdBox"><div class="cdNum" id="cdMins">—</div><div class="cdLbl" data-i18n="cd_mins">Menit</div></div>
          <div class="cdBox"><div class="cdNum" id="cdSecs">—</div><div class="cdLbl" data-i18n="cd_secs">Detik</div></div>
        </div>

        <div class="hr"></div>

        <div class="quote" data-i18n="note_text">
          Dress code rapi & sopan. Mohon hadir 15 menit lebih awal untuk registrasi.
        </div>
      </div>
    </section>

    <section class="section grid">
      <div class="card reveal" id="hadith">
        <div class="cardBody">
          <h2 data-i18n="sec_hadith">Kutipan Hadits Shahih</h2>
          <div class="arabic">
            وَمَنْ سَلَكَ طَرِيقًا يَلْتَمِسُ فِيهِ عِلْمًا سَهَّلَ اللَّهُ لَهُ بِهِ طَرِيقًا إِلَى الْجَنَّةِ
          </div>
          <div class="quote" id="hadithTranslation"></div>
          <div class="source" id="hadithSource"></div>
        </div>
      </div>

      <div class="card reveal" id="kelas">
        <div class="cardBody">
          <h2 data-i18n="sec_classes">Kelas yang Diwisuda</h2>
          <div class="mutedText" data-i18n="classes_desc">Berikut daftar kelas (bisa ditambah kapan saja).</div>
          <div class="hr"></div>
          <div class="classGrid" id="classGrid"></div>
        </div>
      </div>
    </section>

    <section class="section card reveal" id="gallery">
      <div class="cardBody">
        <h2 data-i18n="sec_gallery">Galeri</h2>
        <div class="mutedText" data-i18n="gallery_desc">
          Taruh foto di folder assets/photos/ lalu sesuaikan daftar nama file di CONFIG.galleryImages.
        </div>
        <div class="hr"></div>
        <div class="gallery" id="galleryGrid"></div>
      </div>
    </section>

    <div class="lightbox" id="lightbox" aria-hidden="true">
      <img id="lightboxImg" alt="preview" />
    </div>

    <section class="section card reveal" id="guestbook">
      <div class="cardBody">
        <h2 data-i18n="sec_guestbook">Buku Tamu</h2>
        <div class="mutedText" data-i18n="guestbook_desc">
          Isi ucapan singkat. Jika endpoint Google Sheet diaktifkan, ucapan bisa ditampilkan publik (JSONP).
        </div>
        <div class="hr"></div>

        <form id="gbForm">
          <div class="row2">
            <div>
              <label data-i18n="f_name">Nama</label>
              <input name="name" required placeholder="Nama Anda" />
            </div>
            <div>
              <label data-i18n="f_contact">Kontak (Email / WhatsApp)</label>
              <input name="contact" placeholder="opsional" />
            </div>
          </div>
          <div>
            <label data-i18n="f_message">Pesan / ucapan</label>
            <textarea name="message" required placeholder="Tulis ucapan singkat..."></textarea>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button class="btn ok" type="submit" data-i18n="btn_send_message">Kirim Ucapan</button>
            <button class="btn danger" type="button" id="gbReload" data-i18n="btn_refresh">Muat Ulang</button>
            <span class="mutedText" id="gbInfo"></span>
          </div>
        </form>

        <div class="hr"></div>
        <div class="gbList" id="gbList"></div>
      </div>
    </section>

    <section class="section card reveal" id="rsvp">
      <div class="cardBody">
        <h2 data-i18n="sec_rsvp">RSVP (Konfirmasi Kehadiran)</h2>
        <div class="mutedText" data-i18n="rsvp_hint">
          Isi form di bawah. Jika endpoint Google Sheet belum diaktifkan, data tetap tersimpan di perangkat Anda (local).
        </div>
        <div class="hr"></div>

        <form id="rsvpForm">
          <div class="row2">
            <div>
              <label data-i18n="f_name">Nama</label>
              <input name="name" autocomplete="name" required placeholder="Nama Anda" />
            </div>
            <div>
              <label data-i18n="f_contact">Kontak (Email / WhatsApp)</label>
              <input name="contact" autocomplete="email" placeholder="opsional" />
            </div>
          </div>

          <div>
            <label data-i18n="f_attendance">Kehadiran</label>
            <div class="radioRow">
              <label class="radio"><input type="radio" name="attendance" value="yes" required /><span data-i18n="att_yes">Hadir</span></label>
              <label class="radio"><input type="radio" name="attendance" value="no" /><span data-i18n="att_no">Tidak dapat hadir</span></label>
              <label class="radio"><input type="radio" name="attendance" value="maybe" /><span data-i18n="att_maybe">Masih ragu</span></label>
            </div>
          </div>

          <div class="row2">
            <div>
              <label data-i18n="f_guests">Jumlah orang</label>
              <select name="guests">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
              </select>
            </div>
            <div>
              <label data-i18n="f_lang">Bahasa</label>
              <select name="lang" id="langSelect">
                <option value="id">Indonesia</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
              </select>
            </div>
          </div>

          <div>
            <label data-i18n="f_note">Catatan (opsional)</label>
            <textarea name="note" placeholder="Contoh: hadir 2 orang, dsb."></textarea>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button class="btn ok" type="submit" data-i18n="btn_submit">Kirim RSVP</button>
            <button class="btn danger" type="button" id="btnReset" data-i18n="btn_reset">Reset</button>
            <span class="mutedText" id="saveInfo"></span>
          </div>
        </form>
      </div>
    </section>
  </div>

  <!-- Bottom navigation (mobile) -->
  <nav class="bottomNav" aria-label="Navigation">
    <a class="navItem active" href="#detail" data-nav="detail">
      <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      <span>Detail</span>
    </a>
    <a class="navItem" href="#kelas" data-nav="kelas">
      <svg viewBox="0 0 24 24" fill="none"><path d="M4 19V7l8-4 8 4v12l-8 4-8-4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
      <span>Kelas</span>
    </a>
    <a class="navItem" href="#gallery" data-nav="gallery">
      <svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16v12H4V7Z" stroke="currentColor" stroke-width="2"/><path d="M8 11l2 2 3-3 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Galeri</span>
    </a>
    <a class="navItem" href="#guestbook" data-nav="guestbook">
      <svg viewBox="0 0 24 24" fill="none"><path d="M6 4h12v16H6V4Z" stroke="currentColor" stroke-width="2"/><path d="M8 8h8M8 12h8M8 16h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      <span>Ucapan</span>
    </a>
    <a class="navItem" href="#rsvp" data-nav="rsvp">
      <svg viewBox="0 0 24 24" fill="none"><path d="M7 12l3 3 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 12a8 8 0 1 1-16 0 8 8 0 0 1 16 0Z" stroke="currentColor" stroke-width="2"/></svg>
      <span>RSVP</span>
    </a>
  </nav>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Musik (opsional): assets/bgm.mp3 -->
  <audio id="bgm" loop preload="none">
    <source src="./assets/bgm.mp3" type="audio/mpeg" />
  </audio>

<script>
/***********************
 * CONFIG
 ***********************/
const CONFIG = {
  eventTitle: "RBM Japan Student Graduation Ceremony",
  startISO: "2026-01-24T13:00:00+09:00",  // ubah jam jika sudah final
  endISO:   "2026-01-24T16:00:00+09:00",
  venueName: "十日市場地区センター",
  addressLine: "〒226-0025 神奈川県横浜市緑区十日市場町808-3",
  mapQuery: "十日市場地区センター",
  ENDPOINT: "https://script.google.com/macros/s/AKfycbwGA8_bsewf_rmdF4DbRQoT0pRR2dQ03DUHRwZIJP0K847smDncQWiNQzur9Cl34eKu/exec", // Apps Script Web App URL (opsional)

  // TEMPAT FOTO COVER (animasi slideshow)
  coverImages: [
    "./assets/photos/01.jpg",
    "./assets/photos/02.jpg",
    "./assets/photos/03.jpg"
  ],
  // TEMPAT FOTO GALERI
  galleryImages: [
    "./assets/photos/01.jpg",
    "./assets/photos/02.jpg",
    "./assets/photos/03.jpg",
    "./assets/photos/04.jpg"
  ],
  classes: [
    { name: "Kelas Qur’an Darat", desc: "Program pembinaan tilawah dan pemahaman dasar." },
    { name: "Kelas Iqro’ Darat", desc: "Penguatan baca tulis Al-Qur’an (tahap Iqro’)." },
    { name: "Kelas PAI Semester 1", desc: "Materi PAI semester 1." },
    { name: "Kelas PAI Semester 2", desc: "Materi PAI semester 2." },
    { name: "Kelas Nuroniyah Kids", desc: "Kelas anak-anak (kids)." },
  ]
};

/***********************
 * i18n
 ***********************/
const I18N = {
  id: {
    top_title:"RBM Japan • Kelulusan",
    top_sub:"Undangan Web + RSVP",
    badge_event:"Acara Kelulusan",
    to_default:"Kepada Yth: Tamu Undangan",
    cover_title:"Undangan Kelulusan Siswa RBM Japan",
    cover_desc:"Mari rayakan pencapaian para siswa. Klik tombol di bawah untuk membuka undangan dan mengisi RSVP.",
    btn_open:"Buka Undangan",
    btn_share:"Bagikan",
    btn_map:"Buka Peta",
    btn_calendar:"Tambah ke Kalender",

    sec_detail:"Detail Acara",
    k_when:"Waktu", k_where:"Tempat", k_access:"Akses",
    access_text:"± 5–6 menit jalan kaki dari JR 横浜線 十日市場駅.",
    sec_countdown:"Hitung Mundur",
    cd_days:"Hari", cd_hours:"Jam", cd_mins:"Menit", cd_secs:"Detik",
    note_text:"Dress code rapi & sopan. Mohon hadir 15 menit lebih awal untuk registrasi.",

    sec_hadith:"Kutipan Hadits Shahih",
    hadith_tr:"“Barangsiapa menempuh jalan untuk mencari ilmu, maka Allah akan memudahkan baginya jalan menuju surga.”",
    hadith_src:"HR. Muslim (no. 2699) — potongan lafaz tentang menuntut ilmu.",

    sec_classes:"Kelas yang Diwisuda",
    classes_desc:"Berikut daftar kelas (bisa ditambah kapan saja).",

    sec_gallery:"Galeri",
    gallery_desc:"Taruh foto di folder assets/photos/ lalu sesuaikan daftar nama file di CONFIG.galleryImages.",

    sec_guestbook:"Buku Tamu",
    guestbook_desc:"Isi ucapan singkat. Jika endpoint Google Sheet diaktifkan, ucapan bisa ditampilkan publik (JSONP).",

    sec_rsvp:"RSVP (Konfirmasi Kehadiran)",
    rsvp_hint:"Isi form di bawah. Jika endpoint Google Sheet belum diaktifkan, data tetap tersimpan di perangkat Anda (local).",

    f_name:"Nama",
    f_contact:"Kontak (Email / WhatsApp)",
    f_message:"Pesan / ucapan",
    f_attendance:"Kehadiran",
    att_yes:"Hadir", att_no:"Tidak dapat hadir", att_maybe:"Masih ragu",
    f_guests:"Jumlah orang",
    f_lang:"Bahasa",
    f_note:"Catatan (opsional)",
    btn_send_message:"Kirim Ucapan",
    btn_refresh:"Muat Ulang",
    btn_submit:"Kirim RSVP",
    btn_reset:"Reset",

    toast_share:"Link undangan disalin.",
    toast_music_on:"Musik: ON",
    toast_music_off:"Musik: OFF",
    toast_saved_local:"Tersimpan di perangkat (local).",
    toast_sent:"Terkirim.",
    toast_failed:"Gagal kirim ke server. Tetap tersimpan lokal."
  },
  en: {
    top_title:"RBM Japan • Graduation",
    top_sub:"Web Invitation + RSVP",
    badge_event:"Graduation Ceremony",
    to_default:"To: Invited Guest",
    cover_title:"RBM Japan Student Graduation Ceremony Invitation",
    cover_desc:"Let’s celebrate our students’ achievement. Tap below to open the invitation and submit your RSVP.",
    btn_open:"Open Invitation",
    btn_share:"Share",
    btn_map:"Open Map",
    btn_calendar:"Add to Calendar",

    sec_detail:"Event Details",
    k_when:"When", k_where:"Where", k_access:"Access",
    access_text:"Approx. 5–6 minutes walk from JR Yokohama Line Tokaichiba Station.",
    sec_countdown:"Countdown",
    cd_days:"Days", cd_hours:"Hours", cd_mins:"Minutes", cd_secs:"Seconds",
    note_text:"Dress neatly and respectfully. Please arrive 15 minutes early for registration.",

    sec_hadith:"Authentic Hadith Quote",
    hadith_tr:"“Whoever travels a path in search of knowledge, Allah will make easy for him a path to Paradise.”",
    hadith_src:"Sahih Muslim (no. 2699) — excerpt on seeking knowledge.",

    sec_classes:"Graduating Classes",
    classes_desc:"Class list (you can add more later).",

    sec_gallery:"Gallery",
    gallery_desc:"Put photos in assets/photos/ and update CONFIG.galleryImages.",

    sec_guestbook:"Guestbook",
    guestbook_desc:"Leave a message. If Sheets endpoint is enabled, messages can be shown publicly (JSONP).",

    sec_rsvp:"RSVP (Attendance Confirmation)",
    rsvp_hint:"Fill in the form. If endpoint is not enabled, your response is saved locally.",

    f_name:"Name",
    f_contact:"Contact (Email / WhatsApp)",
    f_message:"Message",
    f_attendance:"Attendance",
    att_yes:"Attending", att_no:"Not attending", att_maybe:"Maybe",
    f_guests:"Number of people",
    f_lang:"Language",
    f_note:"Note (optional)",
    btn_send_message:"Send Message",
    btn_refresh:"Refresh",
    btn_submit:"Submit RSVP",
    btn_reset:"Reset",

    toast_share:"Invitation link copied.",
    toast_music_on:"Music: ON",
    toast_music_off:"Music: OFF",
    toast_saved_local:"Saved locally on your device.",
    toast_sent:"Sent.",
    toast_failed:"Server failed. Still saved locally."
  },
  ja: {
    top_title:"RBM Japan • 卒業式",
    top_sub:"Web招待状 + RSVP",
    badge_event:"卒業式",
    to_default:"ご招待：ゲスト様",
    cover_title:"RBM Japan 卒業式のご案内",
    cover_desc:"生徒の門出を一緒にお祝いしましょう。下のボタンから招待状を開き、出欠をご回答ください。",
    btn_open:"招待状を開く",
    btn_share:"共有",
    btn_map:"地図を開く",
    btn_calendar:"カレンダーに追加",

    sec_detail:"開催情報",
    k_when:"日時", k_where:"会場", k_access:"アクセス",
    access_text:"JR横浜線「十日市場駅」から徒歩約5〜6分。",
    sec_countdown:"カウントダウン",
    cd_days:"日", cd_hours:"時間", cd_mins:"分", cd_secs:"秒",
    note_text:"服装は清潔感のあるものを推奨します。受付のため15分前のご来場にご協力ください。",

    sec_hadith:"真正なハディースの引用",
    hadith_tr:"「知識を求めて道を歩む者には、アッラーが楽園への道を容易にして下さる」",
    hadith_src:"サヒーフ・ムスリム（2699）— 知識探求に関する一節。",

    sec_classes:"卒業クラス",
    classes_desc:"クラス一覧（追加可能）",

    sec_gallery:"ギャラリー",
    gallery_desc:"assets/photos/ に写真を入れ、CONFIG.galleryImages を更新してください。",

    sec_guestbook:"ゲストブック",
    guestbook_desc:"メッセージをご記入ください。Sheets連携があれば公開表示も可能（JSONP）。",

    sec_rsvp:"RSVP（出欠回答）",
    rsvp_hint:"フォームにご入力ください。未設定でも端末に保存されます。",

    f_name:"お名前",
    f_contact:"連絡先（Email / WhatsApp）",
    f_message:"メッセージ",
    f_attendance:"出欠",
    att_yes:"出席", att_no:"欠席", att_maybe:"未定",
    f_guests:"人数",
    f_lang:"言語",
    f_note:"備考（任意）",
    btn_send_message:"送信",
    btn_refresh:"更新",
    btn_submit:"送信",
    btn_reset:"リセット",

    toast_share:"リンクをコピーしました。",
    toast_music_on:"音楽：ON",
    toast_music_off:"音楽：OFF",
    toast_saved_local:"端末に保存しました。",
    toast_sent:"送信しました。",
    toast_failed:"サーバー送信に失敗。端末には保存されています。"
  }
};

/***********************
 * Helpers
 ***********************/
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>Array.from(document.querySelectorAll(q));
const state = { lang:"id", slideIndex:0, slideFlip:false, musicOn:false, opened:false };

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._timer);
  toast._timer = setTimeout(()=>t.classList.remove("show"), 3200);
}

function pad2(n){ return String(n).padStart(2,"0"); }

function formatWhen(lang){
  const s = new Date(CONFIG.startISO);
  const e = new Date(CONFIG.endISO);
  const yyyy = s.getFullYear();
  const mm = s.getMonth()+1;
  const dd = s.getDate();
  const dow = s.getDay();
  const dowId = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"][dow];
  const dowEn = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][dow];
  const dowJa = ["日","月","火","水","木","金","土"][dow];
  const time = `${pad2(s.getHours())}:${pad2(s.getMinutes())}–${pad2(e.getHours())}:${pad2(e.getMinutes())} JST`;
  if(lang==="id") return `${dowId}, ${dd} Januari ${yyyy} • ${time}`;
  if(lang==="en") return `${dowEn}, January ${dd}, ${yyyy} • ${time}`;
  return `${yyyy}年${mm}月${dd}日（${dowJa}） • ${time}`;
}

function getQueryParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

function safeText(s){
  return String(s || "").replace(/[<>&"]/g, c => ({ "<":"&lt;", ">":"&gt;", "&":"&amp;", "\"":"&quot;" }[c]));
}

function setLang(lang){
  state.lang = lang;
  document.documentElement.lang = lang;
  $$(".chip").forEach(c=>c.classList.toggle("active", c.dataset.lang===lang));
const langSelect = document.getElementById("langSelect");
if (langSelect) langSelect.value = lang;


  $$("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    if(I18N[lang][key] != null) el.textContent = I18N[lang][key];
  });
  $("#hadithTranslation").textContent = I18N[lang].hadith_tr;
  $("#hadithSource").textContent = I18N[lang].hadith_src;

  $("#whenText").textContent = formatWhen(lang);
  $("#addrText").textContent = CONFIG.addressLine;

  $("#btnMap").href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(CONFIG.mapQuery)}`;
}

function startSlides(){
  const a = $("#slideA");
  const b = $("#slideB");
  const imgs = CONFIG.coverImages.filter(Boolean);
  if(imgs.length === 0) return;

  const setBg = (el, url)=> el.style.backgroundImage = `url("${url}")`;
  setBg(a, imgs[0]);
  setBg(b, imgs[1 % imgs.length]);

  setInterval(()=>{
    state.slideIndex = (state.slideIndex + 1) % imgs.length;
    const next = imgs[state.slideIndex];

    state.slideFlip = !state.slideFlip;
    const active = state.slideFlip ? b : a;
    const inactive = state.slideFlip ? a : b;

    setBg(inactive, next);
    inactive.classList.add("active");
    active.classList.remove("active");
  }, 5500);
}

function startCountdown(){
  const target = new Date(CONFIG.startISO).getTime();
  function tick(){
    const now = Date.now();
    let diff = Math.max(0, target - now);

    const d = Math.floor(diff / (24*3600*1000)); diff -= d*24*3600*1000;
    const h = Math.floor(diff / (3600*1000)); diff -= h*3600*1000;
    const m = Math.floor(diff / (60*1000)); diff -= m*60*1000;
    const s = Math.floor(diff / 1000);

    $("#cdDays").textContent = d;
    $("#cdHours").textContent = pad2(h);
    $("#cdMins").textContent = pad2(m);
    $("#cdSecs").textContent = pad2(s);
  }
  tick();
  setInterval(tick, 1000);
}

function buildICS(){
  const dtStart = new Date(CONFIG.startISO);
  const dtEnd = new Date(CONFIG.endISO);
  const toICS = (d)=>{
    const u = new Date(d.getTime());
    const yyyy = u.getUTCFullYear();
    const mm = pad2(u.getUTCMonth()+1);
    const dd = pad2(u.getUTCDate());
    const hh = pad2(u.getUTCHours());
    const mi = pad2(u.getUTCMinutes());
    const ss = pad2(u.getUTCSeconds());
    return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
  };
  const uid = `rbm-grad-${Date.now()}@rbm-japan`;
  return [
    "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//RBM Japan//Graduation//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH",
    "BEGIN:VEVENT",
    `UID:${uid}`,
    `DTSTAMP:${toICS(new Date())}`,
    `DTSTART:${toICS(dtStart)}`,
    `DTEND:${toICS(dtEnd)}`,
    `SUMMARY:${CONFIG.eventTitle}`,
    `LOCATION:${CONFIG.venueName} (${CONFIG.addressLine})`,
    "DESCRIPTION:RBM Japan Graduation Ceremony",
    "END:VEVENT",
    "END:VCALENDAR"
  ].join("\r\n");
}

async function shareLink(){
  const url = location.href;
  try{
    if(navigator.share){
      await navigator.share({ title: document.title, url });
      return;
    }
    await navigator.clipboard.writeText(url);
    toast(I18N[state.lang].toast_share);
  }catch{
    prompt("Copy link:", url);
  }
}

/* Ripple effect */
function addRipple(e){
  const btn = e.currentTarget;
  const r = document.createElement("span");
  r.className = "ripple";
  const rect = btn.getBoundingClientRect();
  const x = (e.clientX || (rect.left + rect.width/2)) - rect.left;
  const y = (e.clientY || (rect.top + rect.height/2)) - rect.top;
  r.style.left = `${x}px`;
  r.style.top = `${y}px`;
  r.style.width = r.style.height = `${Math.max(rect.width, rect.height)}px`;
  btn.appendChild(r);
  setTimeout(()=>r.remove(), 600);
}

/* Confetti (lightweight) */
function confettiBurst(durationMs=1500){
  const canvas = $("#confetti");
  const ctx = canvas.getContext("2d");
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  function resize(){
    canvas.width = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    canvas.style.width = innerWidth + "px";
    canvas.style.height = innerHeight + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resize();
  window.addEventListener("resize", resize, { passive:true });

  const colors = ["#ffffff","#ffcc00","#00f5d4","#ff2ad4","#0b2cff"];
  const parts = Array.from({length: 120}, ()=>({
    x: Math.random()*innerWidth,
    y: -20 - Math.random()*innerHeight*0.2,
    vx: (Math.random()*2-1)*3,
    vy: 3 + Math.random()*6,
    w: 4 + Math.random()*5,
    h: 6 + Math.random()*8,
    rot: Math.random()*Math.PI,
    vr: (Math.random()*2-1)*0.2,
    c: colors[Math.floor(Math.random()*colors.length)]
  }));

  const t0 = performance.now();
  function frame(t){
    const dt = (t - t0);
    ctx.clearRect(0,0,innerWidth,innerHeight);

    parts.forEach(p=>{
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.05; // gravity
      p.rot += p.vr;
      // wrap sides
      if(p.x < -30) p.x = innerWidth + 30;
      if(p.x > innerWidth + 30) p.x = -30;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.c;
      ctx.globalAlpha = 0.95;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    });

    if(dt < durationMs){
      requestAnimationFrame(frame);
    }else{
      ctx.clearRect(0,0,innerWidth,innerHeight);
      window.removeEventListener("resize", resize);
    }
  }
  requestAnimationFrame(frame);
}

/* Reveal on scroll */
function initReveal(){
  const els = $$(".reveal");
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(en=>{
      if(en.isIntersecting) en.target.classList.add("show");
    });
  }, { threshold: 0.12 });
  els.forEach(el=>io.observe(el));
}

/* Render classes */
function renderClasses(){
  $("#classGrid").innerHTML = CONFIG.classes.map(c=>`
    <div class="classCard">
      <b>${safeText(c.name)}</b>
      <div class="small">${safeText(c.desc || "")}</div>
    </div>
  `).join("");
}

/* Render gallery */
function renderGallery(){
  const imgs = CONFIG.galleryImages.filter(Boolean);
  $("#galleryGrid").innerHTML = imgs.map((src, idx)=>`
    <div class="gItem" data-src="${safeText(src)}" aria-label="photo ${idx+1}">
      <img src="${safeText(src)}" alt="photo ${idx+1}">
    </div>
  `).join("");

  $$("#galleryGrid .gItem").forEach(el=>{
    el.addEventListener("click", ()=>{
      $("#lightboxImg").src = el.dataset.src;
      $("#lightbox").classList.add("show");
      $("#lightbox").setAttribute("aria-hidden","false");
    });
  });
}
$("#lightbox").addEventListener("click", ()=>{
  $("#lightbox").classList.remove("show");
  $("#lightbox").setAttribute("aria-hidden","true");
  $("#lightboxImg").src = "";
});

/* Music toggle */
async function toggleMusic(){
  const audio = $("#bgm");
  try{
    if(!state.musicOn){
      await audio.play();
      state.musicOn = true;
      toast(I18N[state.lang].toast_music_on);
    }else{
      audio.pause();
      state.musicOn = false;
      toast(I18N[state.lang].toast_music_off);
    }
  }catch{
    toast("Musik tidak bisa diputar (cek assets/bgm.mp3).");
  }
}
$("#btnMusic").addEventListener("click", toggleMusic);

/* Bottom nav active highlight */
function initBottomNav(){
  const items = $$(".navItem");
  const sections = items.map(i => document.getElementById(i.getAttribute("href").slice(1))).filter(Boolean);

  const io = new IntersectionObserver((entries)=>{
    // pick most visible
    let best = null;
    for(const e of entries){
      if(e.isIntersecting){
        if(!best || e.intersectionRatio > best.intersectionRatio) best = e;
      }
    }
    if(best){
      const id = best.target.id;
      items.forEach(it=>it.classList.toggle("active", it.getAttribute("href")==="#"+id));
    }
  }, { threshold: [0.2, 0.35, 0.5, 0.65] });

  sections.forEach(s=>io.observe(s));
}

/* Local + endpoint (optional) */
const KEY_RSVP = "rbm_rsvp_latest_v1";
const KEY_GB = "rbm_guestbook_local_v1";

async function postToEndpoint(payload){
  if(!CONFIG.ENDPOINT) return { ok:false, reason:"no-endpoint" };
  const res = await fetch(CONFIG.ENDPOINT, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload),
  });
  if(!res.ok) throw new Error("HTTP " + res.status);
  return { ok:true };
}

function renderGuestbookLocal(){
  const list = $("#gbList");
  const arr = JSON.parse(localStorage.getItem(KEY_GB) || "[]");
  if(arr.length === 0){
    list.innerHTML = `<div class="mutedText">—</div>`;
    return;
  }
  list.innerHTML = arr.slice(0, 20).map(x=>`
    <div class="gbItem">
      <div><b>${safeText(x.name)}</b></div>
      <div>${safeText(x.message)}</div>
      <div class="meta">${safeText(new Date(x.ts).toLocaleString("id-ID"))}</div>
    </div>
  `).join("");
}

function loadGuestbookFromEndpoint(){
  const info = $("#gbInfo");
  if(!CONFIG.ENDPOINT){
    info.textContent = I18N[state.lang].toast_saved_local;
    renderGuestbookLocal();
    return;
  }

  window.renderGuestbook = function(data){
    const list = $("#gbList");
    if(!Array.isArray(data) || data.length === 0){
      list.innerHTML = `<div class="mutedText">—</div>`;
      return;
    }
    list.innerHTML = data.map(x=>`
      <div class="gbItem">
        <div><b>${safeText(x.name || "")}</b></div>
        <div>${safeText(x.message || "")}</div>
        <div class="meta">${safeText(x.tsText || "")}</div>
      </div>
    `).join("");
  };

  const s = document.createElement("script");
  s.src = `${CONFIG.ENDPOINT}?mode=guestbook&limit=20&callback=renderGuestbook&_=${Date.now()}`;
  s.onerror = ()=>{
    info.textContent = I18N[state.lang].toast_failed;
    renderGuestbookLocal();
  };
  document.body.appendChild(s);
  setTimeout(()=>{ try{s.remove()}catch{} }, 8000);
}

$("#gbReload").addEventListener("click", loadGuestbookFromEndpoint);

$("#gbForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    type: "guestbook",
    name: String(fd.get("name")||"").trim(),
    contact: String(fd.get("contact")||"").trim(),
    message: String(fd.get("message")||"").trim(),
    lang: state.lang,
    meta: { page: location.href, ua: navigator.userAgent, ts: new Date().toISOString() }
  };

  const arr = JSON.parse(localStorage.getItem(KEY_GB) || "[]");
  arr.unshift({ name: payload.name, message: payload.message, ts: Date.now() });
  localStorage.setItem(KEY_GB, JSON.stringify(arr));

  try{
    if(CONFIG.ENDPOINT) await postToEndpoint(payload);
    toast(I18N[state.lang].toast_sent);
  }catch{
    toast(I18N[state.lang].toast_failed);
  }finally{
    e.target.reset();
    loadGuestbookFromEndpoint();
  }
});

$("#rsvpForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    type: "rsvp",
    name: String(fd.get("name")||"").trim(),
    contact: String(fd.get("contact")||"").trim(),
    attendance: String(fd.get("attendance")||""),
    guests: String(fd.get("guests")||"1"),
    note: String(fd.get("note")||"").trim(),
    lang: String(fd.get("lang")||state.lang),
    meta: { page: location.href, ua: navigator.userAgent, ts: new Date().toISOString() },
    event: { title: CONFIG.eventTitle, startISO: CONFIG.startISO, venue: CONFIG.venueName }
  };

  localStorage.setItem(KEY_RSVP, JSON.stringify(payload));
  $("#saveInfo").textContent = I18N[state.lang].toast_saved_local;

  try{
    if(CONFIG.ENDPOINT) await postToEndpoint(payload);
    toast(I18N[state.lang].toast_sent);
  }catch{
    toast(I18N[state.lang].toast_failed);
  }
});

$("#btnReset").addEventListener("click", ()=>{
  $("#rsvpForm").reset();
  $("#saveInfo").textContent = "";
});

/* Cover open flow */
function openInvitation(){
  if(state.opened) return;
  state.opened = true;

  document.body.classList.add("opened");
  confettiBurst(1400);

  // (opsional) start music on open (browser membutuhkan user gesture → ini valid)
  toggleMusic().catch(()=>{});

  // scroll to first section after short delay for smoothness
  setTimeout(()=> document.getElementById("detail").scrollIntoView({behavior:"smooth", block:"start"}), 180);
}

$("#btnOpen").addEventListener("click", (e)=>{
  addRipple(e);
  openInvitation();
});

["btnShare","btnCalendar"].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener("click", addRipple);
});
$("#btnShare").addEventListener("click", shareLink);
$("#btnCalendar").addEventListener("click", ()=>{
  const ics = buildICS();
  const blob = new Blob([ics], { type:"text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "RBM-Japan-Graduation.ics";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
});

/* Language controls */
$$(".chip").forEach(ch => ch.addEventListener("click", ()=> setLang(ch.dataset.lang)));
$("#langSelect").addEventListener("change", (e)=> setLang(e.target.value));

/* Personalization ?to= */
const to = getQueryParam("to");
if(to){
  const name = decodeURIComponent(to);
  const t = document.getElementById("toLine");
  t.textContent = `Kepada Yth: ${name}`;
  // prefill
  const rsvpName = document.querySelector('#rsvpForm input[name="name"]');
  const gbName = document.querySelector('#gbForm input[name="name"]');
  if(rsvpName && !rsvpName.value) rsvpName.value = name;
  if(gbName && !gbName.value) gbName.value = name;
}

/* Init */
setLang("id");
document.getElementById("whenText").textContent = formatWhen("id");
document.getElementById("addrText").textContent = CONFIG.addressLine;
document.getElementById("btnMap").href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(CONFIG.mapQuery)}`;

renderClasses();
renderGallery();
startSlides();
startCountdown();
initReveal();
initBottomNav();
loadGuestbookFromEndpoint();
</script>
</body>
</html>
